---
title: "Regression Splines"
author: "Andrew Zieffler"
date: "11/13/2018"
output: 
  html_document:
    theme: united
    highlight: tango
    css: my_style2.css
bibliography: epsy8264.bib
csl: apa-single-spaced.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 6, fig.height = 6, out.width = "40%", message=FALSE, warning=FALSE, fig.align = 'center')
```


```{r message=FALSE}
# Load libraries
library(broom)
library(car)
library(dplyr)
library(ggplot2)
library(readr)
library(sm)
```

In the last set of notes we fitted a continuous linear piecewise model to the Tokyo water data. There is nothing that limits the degree of the piecewise model fitted to be degree one (linear). We could fit a higher order polynomial model to each region of the data as well. For example, below, we fit not only the linear piecewise model, but also the quadratic and cubic piecewise models to a toy data set. In each of these fits, we used knots $k_1=4$ and $k_2=7$.

```{r echo=FALSE, fig.align='center', fig.width=12, fig.height=4, out.width='80%'}
fake = read_csv("~/Dropbox/epsy-8264/data/fake-piecewise-data.csv")

fake = fake %>%
  mutate(
    I_1 = if_else(x <= 4, 0, x - 4),
    I_2 = if_else(x <= 7, 0, x - 7)
  )

# Fit linear piecewise model
lm.pw.1 = lm(y ~ 1 + x +                   I_1 +                       I_2,                       data = fake)
lm.pw.2 = lm(y ~ 1 + x + I(x^2) +          I_1 + I(I_1^2) +            I_2 + I(I_2^2),            data = fake)
lm.pw.3 = lm(y ~ 1 + x + I(x^2) + I(x^3) + I_1 + I(I_1^2) + I(I_1^3) + I_2 + I(I_2^2) + I(I_2^3), data = fake)


# Create data set for plot
plot_data = data.frame(
  x = seq(from = 0, to = 10, by = 0.1)
) %>%
  mutate(
    I_1 = if_else(x <= 4, 0, x - 4),
    I_2 = if_else(x <= 7, 0, x - 7)
  )

# Add in fitted values
plot_data = plot_data %>%
  mutate(
    yhat1 = predict(lm.pw.1, newdata = plot_data),
    yhat2 = predict(lm.pw.2, newdata = plot_data),
    yhat3 = predict(lm.pw.3, newdata = plot_data)
  ) %>%
  tidyr::gather(model, yhat, yhat1:yhat3) %>%
  mutate(
    model = factor(model, levels = c("yhat1", "yhat2", "yhat3"), labels = c("Linear", "Quadratic", "Cubic"))
  )


ggplot(data = plot_data, aes(x = x, y = yhat)) +
  geom_vline(xintercept = c(4, 7), linetype = "dotted") +
  geom_point(data = fake, aes(x = x, y = y), alpha = 0.5) +
  geom_line() +
  theme_bw() +
  scale_x_continuous(name = "X", breaks = seq(from = 0, to = 10, by = 2)) +
  scale_y_continuous(
    name = "Y", 
    breaks = seq(from = -1.5, to = 3, by = 0.5)
  ) +
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank()
  ) +
  facet_wrap(~model)
```

The plot of the fitted models are show: 

- **Linear Piecewise Model:** A linear model has been fitted to each of the three regions of the data with the constraint that the fitted models for two adjacent regions intersect at the knot.
- **Quadratic Piecewise Model:** A quadratic polynomial model has been fitted to each of the three regions of the data with the constraint that the fitted models for two adjacent regions intersect at the knot.
- **Cubic Piecewise Model:** A cubic polynomial model has been fitted to each of the three regions of the data with the constraint that the fitted models for two adjacent regions intersect at the knot.


## Tokyo Water Example: Quadratic Piecewise Model

The data in *tokyo-water-use.csv* were collected due to concerns about the provision of potable water to large metropolitan areas, which is a potential problem resulting from human-induced climate change. The data consist of 27 years worth of residential water use (measured in 1000s of cubic feet). We previously fitted a linear piecewise model to the data based on knots we defined at 1980 and 1992, and constrained these piecewise models to be continous at the knots. Below we fit both the continous linear and quadratic piecewise models.

```{r message=FALSE}
# Import data
tokyo = read_csv("~/Dropbox/epsy-8264/data/tokyo-water-use.csv")


# Create indicators
tokyo = tokyo %>%
  mutate(
    I_1 = if_else(year <= 1980, 0, year - 1980),
    I_2 = if_else(year <= 1992, 0, year - 1992)
  )


# Fit linear piecewise model
lm.pw.1 = lm(water_use ~ 1 + year + I_1 + I_2, data = tokyo)


# Fit quadratic piecewise model
lm.pw.2 = lm(water_use ~ 1 + year + I(year^2) + I_1 + I(I_1^2) + I_2 + I(I_2^2), data = tokyo)
```

The plot of the fitted models are shown below. Note that in the quadratic piecewise model a quadratic model has been fitted to each of the three regions of the data. Again, these models have been constrained to be continuous so that they intersect at the knots.

```{r fig.width=8, fig.height=4, out.width='60%'}
# Create data set for plot
plot_data = data.frame(
  year = seq(from = 1973, to = 1999, by = 0.1)
) %>%
  mutate(
    I_1 = if_else(year <= 1980, 0, year - 1980),
    I_2 = if_else(year <= 1992, 0, year - 1992)
  )

# Add in fitted values
plot_data = plot_data %>%
  mutate(
    yhat1 = predict(lm.pw.1, newdata = plot_data),
    yhat2 = predict(lm.pw.2, newdata = plot_data)
  ) %>%
  tidyr::gather(model, yhat, yhat1:yhat2) %>%
  mutate(
    model = factor(model, levels = c("yhat1", "yhat2"), labels = c("Linear", "Quadratic"))
  )


# Plot
ggplot(data = plot_data, aes(x = year, y = yhat)) +
  geom_line() +
  geom_point(data = tokyo, aes(x = year, y = water_use), alpha = 0.5) +
  theme_bw() +
  scale_x_continuous(name = "Year", breaks = seq(from = 1970, to = 2005, by = 5)) +
  scale_y_continuous(
    name = "Residential water use (in 1000 cubic feet)", 
    breaks = seq(from = 600000, to = 740000, by = 20000)
    ) +
  facet_wrap(~model)
```

Examining the residuals from the two fitted models, it appears that the quadratic piecewise model has better fit to the data. 

```{r echo=FALSE, fig.width=8, fig.height=4, out.width='60%'}
# Augment the model
out_pw_1 = augment(lm.pw.1)
out_pw_2 = augment(lm.pw.2)

# Evalate residuals
par(mfrow=c(1, 2))
sm.density(out_pw_1$.std.resid, model = "normal", xlab = "Standardized residuals from Linear model")
sm.density(out_pw_2$.std.resid, model = "normal", xlab = "Standardized residuals from Quadratic model")
par(mfrow=c(1, 1))

p1 = out_pw_1 %>%
  ggplot(aes(x = .fitted, y = .std.resid)) +
  geom_point()  +
  geom_smooth() +
  geom_hline(yintercept = 0) +
  theme_bw() +
  xlab("Fitted values") +
  ylab("Standardized residuals") +
  ggtitle("Linear")

p2 = out_pw_2 %>%
  ggplot(aes(x = .fitted, y = .std.resid)) +
  geom_point()  +
  geom_smooth() +
  geom_hline(yintercept = 0) +
  theme_bw() +
  xlab("Fitted values") +
  ylab("Standardized residuals") +
  ggtitle("Quadratic")

gridExtra::grid.arrange(p1, p2, nrow = 1)
```


Adopting the quadratic model suggests that over time, residential water useage is non-linear wihin each of the data regions. Prior to 1980 there is rapid increase in water use followed by rapid decrease. From 1980 to 1992, residential water use grows at an ever increasing (non-linear) rate until 1992 at which time water use decreases non-linearly until about 1996. Since then, water use seems to be increasing.

## Spline Models

Although the piecewise quadratic model indicates better residual fit, one problem with it is that the points at which the piecewise models intersect at the knots are quite unnatural; there is abrupt changes in the relationship between time and water use at these points. This is simply a function of the continuity constraint that we added to the model. To alleviate these abrupt changes at the knots we impose two additional constraints:

- The first derivative of the piecewise functions be continuous at the knots; and
- The second derivative of the piecewise functions be continuous at the knots.

These constraints will impose not only continuity of the function at the knots, but will also impose *smoothness* of the function at the knots. The piecewise polynomial models having these additional smoothing contraints are referred to as *spline models*. To illustrate this, we fit a set of cubic piecewise models to the same toy dataset we saw earlier. The first cubic model (a) has no constraints, the second cubic model (b) has the constraint of continuity in $f(x)$, and the third cubic model, a cubic spline (c), has the the constraints of continuity in $f(x)$, $f^{\prime}(x)$, and $f^{\prime\prime}(x)$.


```{r echo=FALSE, fig.align='center', fig.width=12, fig.height=4, out.width='80%'}
library(splines)
fake = fake %>%
  mutate(
    I_1 = if_else(x <= 4, 0, x - 4),
    I_2 = if_else(x <= 7, 0, x - 7)
  )

# Fit cubic piecewise model
lm.pw.3 = lm(y ~ 1 + x + I(x^2) + I(x^3) + I_1 + I(I_1^2) + I(I_1^3) + I_2 + I(I_2^2) + I(I_2^3), data = fake)

# Cubic spline model
spline.3 = lm(y ~ bs(x, knots = c(4, 7), degree = 3), data = fake)

# Create data set for pw model
plot_data = data.frame(
  x = seq(from = 0, to = 10, by = 0.1)
) %>%
  mutate(
    I_1 = if_else(x <= 4, 0, x - 4),
    I_2 = if_else(x <= 7, 0, x - 7)
  ) %>%
  mutate(yhat = predict(lm.pw.3, newdata = .))

# Create data set for spline model
plot_data2 = data.frame(
  x = seq(from = 0, to = 10, by = 0.1)
  ) %>%
  mutate(yhat = predict(spline.3, newdata = .))


p1 = ggplot(data = fake, aes(x = x, y = y)) +
  geom_vline(xintercept = c(4, 7), linetype = "dotted") +
  geom_point(alpha = 0.5) +
  geom_smooth(data = fake[fake$x <= 4, ], method = "lm", se = FALSE, formula = y~poly(x, 3), color = "black") +
  geom_smooth(data = fake[fake$x > 4 & fake$x <= 7, ], method = "lm", se = FALSE, formula = y~poly(x, 3), color = "black") +
  geom_smooth(data = fake[fake$x > 7, ], method = "lm", se = FALSE, formula = y~poly(x, 3), color = "black") +
  theme_bw() +
  scale_x_continuous(name = "X", breaks = seq(from = 0, to = 10, by = 2)) +
  scale_y_continuous(
    name = "Y", 
    breaks = seq(from = -1.5, to = 3, by = 0.5)
  ) +
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank()
  ) +
  ggtitle("Cubic Piecewise Model (No Constraints)")

p2 = ggplot(data = plot_data, aes(x = x, y = yhat)) +
  geom_vline(xintercept = c(4, 7), linetype = "dotted") +
  geom_point(data = fake, aes(x = x, y = y), alpha = 0.5) +
  geom_line() +
  theme_bw() +
  scale_x_continuous(name = "X", breaks = seq(from = 0, to = 10, by = 2)) +
  scale_y_continuous(
    name = "Y", 
    breaks = seq(from = -1.5, to = 3, by = 0.5)
  ) +
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank()
  )  +
  ggtitle("Cubic Piecewise Model; Continuous on f(x)")

p3 = ggplot(data = plot_data2, aes(x = x, y = yhat)) +
  geom_vline(xintercept = c(4, 7), linetype = "dotted") +
  geom_point(data = fake, aes(x = x, y = y), alpha = 0.5) +
  geom_line() +
  theme_bw() +
  scale_x_continuous(name = "X", breaks = seq(from = 0, to = 10, by = 2)) +
  scale_y_continuous(
    name = "Y", 
    breaks = seq(from = -1.5, to = 3, by = 0.5)
  ) +
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank()
  )  +
  ggtitle("Cubic Piecewise Model; Continuous on f(x), f'(x), and f''(x)")

gridExtra::grid.arrange(p1, p2, p3, nrow = 1)
```

Interestingly, by imposing additional constraints on the model, we gain flexibility in the model (i.e., more constraints are associated with smaller model *df*). In the model fitted in (a) there are 12 *df* for the model; an intercept, linear, quadratic, and cubic term in each of the three regions. For the model fitted in (b) we imposed a continuity constraint on $f(x)$ at each knot, freeing up two *df*, resulting in 10 *df* for this model. In the cubic spline model (c) we imposed continuity constraints on $f(x)$, $f^{\prime}(x)$, and $f^{\prime\prime}(x)$ at each knot, effectively freeing up 6 *df*, so this model has 6 *df*. 

### Comparison to Global Cubic Polynomial Model

Although the results from fitting the spline model look like a cubic polynomial model, the fitted model is actually quite different. The plot below shoiws the fitted cubic spline model (black) and the results of fitting the cubic polynomial model to the entire dat set (blue).

```{r echo=FALSE}
ggplot(data = plot_data2, aes(x = x, y = yhat)) +
  geom_vline(xintercept = c(4, 7), linetype = "dotted") +
  geom_point(data = fake, aes(x = x, y = y), alpha = 0.5) +
  geom_line() +
  theme_bw() +
  scale_x_continuous(name = "X", breaks = seq(from = 0, to = 10, by = 2)) +
  scale_y_continuous(
    name = "Y", 
    breaks = seq(from = -1.5, to = 3, by = 0.5)
  ) +
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank()
  ) +
  geom_smooth(data = fake, aes(y = y),  method = "lm", se = FALSE, formula = y~poly(x, 3))
```

The cubic polynomial shows rapid increase in $y$ until $x=6$ (or so) followed by slight decrease in $y$. The spline model indicates a negative rate of change until $x=1.5$ followed by rapid increase in $y$ unitl $x=5$. Then this function decreases until $x=9$ and then shows rapid increase. The two models show a completely different relationship between $x$ and $y$. 

### General Definition of a Spline

For the cubic spline (degree = 3), we imposed continuity constraints on $f(x)$, $f^{\prime}(x)$, and $f^{\prime\prime}(x)$. In other words, to fit a degree $d$ spline model, we impose continuity constriants on the function and all derivaitves up to $f^{d-1}(x)$. For example, for the quadratic spline (degree = 2) we impose continuity constraints on $f(x)$ and $f^{\prime}(x)$. For a linear spline, we only impose continuity on $f(x)$.

How do we fit a degree $d$ piecewise model so that is function and the derivatives of its function up to the $d-1$th derivate are continuous? According to @James:2013, in order to fit a degree $d$ spline model we include the polynomial predictors of $x$ up to (and including) $x^d$ using an orthogonal basis function (e.g., `poly()`). Then we also include an indicator predictor for each knot that is:

$$
I_k = \begin{cases}
    0 & x \leq k \\
    (x-k)^d & x > k
\end{cases}
$$

By including this indicator, the function and all derivatives up to the $d$th derivative will be continuous at each knot. For example, in our Tokyo data, to fit a cubic spline model with knots at 1980 and 1992, we would fit the following model:

$$
\mathrm{Water~Use}_i = \beta_0 + \beta_1\bigg(b(\mathrm{Year}_i)\bigg) + \beta_2\bigg(b(\mathrm{Year}_i^2)\bigg) + \beta_3\bigg(b(\mathrm{Year}_i^3)\bigg) + \beta_4(I_{1i}) + \beta_5(I_{2i}) + \epsilon_i
$$

where,

$b(.)$ is an orthogonal basis function applied to $x$,

$$
I_1 = \begin{cases}
    0 & \mathrm{Year} \leq 1980 \\
    (\mathrm{Year}-1980)^3 & \mathrm{Year} > 1980
\end{cases}
$$

and

$$
I_2 = \begin{cases}
    0 & \mathrm{Year} \leq 1992 \\
    (\mathrm{Year}-1992)^3 & \mathrm{Year} > 1992
\end{cases}
$$

After creating the indicator varaibles, we can estimate the coefficients using OLS estimation.


```{r}
# Create indicators
tokyo = tokyo %>%
  mutate(
    I_1 = if_else(year <= 1980, 0, (year - 1980)^3),
    I_2 = if_else(year <= 1992, 0, (year - 1992)^3)
  )

# Fit spline model
lm.spline.3 = lm(water_use ~ 1 + poly(year, 3) + I_1 + I_2, data = tokyo)
glance(lm.spline.3)
```

Based on the model-level output, we see that the model has 6 *df* (including the intercept). The coefficient-level output (not shown) is irrelevant to us except as a way of obtaining a plot of the fitted model.

```{r}
# Create plotting data
plot_data = data.frame(
  year = seq(from = 1973, to = 1999, by = 0.1)
  ) %>%
  mutate(
    I_1 = if_else(year <= 1980, 0, (year - 1980)^3),
    I_2 = if_else(year <= 1992, 0, (year - 1992)^3)
  ) %>%
  mutate(
    yhat = predict(lm.spline.3, newdata = .)
  )

# Plot
ggplot(data = plot_data, aes(x = year, y = yhat)) +
  geom_line() +
  geom_point(data = tokyo, aes(x = year, y = water_use), alpha = 0.5) +
  theme_bw() +
  scale_x_continuous(name = "Year", breaks = seq(from = 1970, to = 2005, by = 5)) +
  scale_y_continuous(
    name = "Residential water use (in 1000 cubic feet)", 
    breaks = seq(from = 600000, to = 740000, by = 20000)
  )
```

### Alternative Method for Fitting Spline Model

In practice, we rarely actually create the splines using polynomials and indicators as we just did. Instead, we typically use a B-spline basis for constructing splines, which, although result in the exact same fitted line, have better computational properties. The numerical detail underlying the B-spline basis is beyond the scope of this course, but interested readers can reference @Hastie:2009 for more detail. 

To fit a cubic spline using the B-spline basis, we use the `bs()` function from the **splines** library. This function is applied directly to the predictor in the `lm()` function. There are several useful arguments for this function including: `knots=` to specify the knots, and `degree=` to indicate the degree of polynomial to use (the default is `degree=3`). By default, an intercept is not included in the B-spline basis (although this can be overridden by including `intercept=FALSE`) which is fine since all we care about is the plot of the fitted line, which is identical whether the intercept is included or not. Below we fit the cubic spline to the Tokyo data using the B-spline basis.

```{r}
# Load splines library
library(splines)

# Fit cubic spline using B-spline basis
bs.1 = lm(water_use ~ 1 + bs(year, knots = c(1980, 1992)), data = tokyo)

# Model-level output
glance(bs.1)
```

The model-level output is exactly the same as the cubic spline model we fitted earlier; changing the basis does not change the fit of the model. The coefficient-level output, however, is quite different:

```{r}
# Coefficeint-level output
tidy(bs.1)
```


This is because we used a B-spline basis when we fitted this model. The basis essentially deines the design matrix used. In a B-spline basis, the design matrix is constituted by a set of indicator variables whose values are determined by the knots. Below we show the first ten rows for the design matrix for both spline models.

```{r}
# First 10 rows of design matrix for initial basis---using poly()
model.matrix(lm.spline.3)[1:10, ]

# First 10 rows of design matrix for B-spline basis
model.matrix(bs.1)[1:10, ]
```

Note that the B-spline basis used a set of five indicator variables. These represent five different regions of the data: the three regions defined by the two knots, and two additional boundary regions that extend beyond the data at either side. (Think about adding two additional knots, one beyond the data at each end. This results in five regions that need to be coded.) The main thing is that the two design matrices have the same dimensions, $27 \times 6$, and produce the same hat-matrix, which implies that they produce the same set of fitted values.

### Plotting the Fitted Model

```{r}
# Set up data to plot
plot_data = data.frame(
  year = seq(from = 1973, to = 1999, by = 0.1)
) %>%
  mutate(
    yhat = predict(bs.1, newdata = .)
  )

# Plot
ggplot(data = plot_data, aes(x = year, y = yhat)) +
  geom_line() +
  geom_point(data = tokyo, aes(x = year, y = water_use), alpha = 0.5) +
  theme_bw() +
  scale_x_continuous(name = "Year", breaks = seq(from = 1970, to = 2005, by = 5)) +
  scale_y_continuous(
    name = "Residential water use (in 1000 cubic feet)", 
    breaks = seq(from = 600000, to = 740000, by = 20000)
  )
```

## Choosing Knots

It is important to know that the number of knots chosen and their placement is a big deal. Differing numbers of knots and their values will affect the model! To this point, we have selected the knot values for the model, namely 1980 and 1992. We initially chose these values from a visual inspection of the data. 

Like many other endeavors in modeling, the analyst should choose both the number of knots and their values *before looking at the data*. This, ideally would be done using substantive knowledge to include more knots where $f(x)$ changes the most rapidly, and placing fewer knots where the function is more stable. 

In practice, one of two things typically happens. Either the analyst chooses knot placement by combining their substantive knowledge along with some data snooping (looking at the data), or the knots are placed in a uniform manner across the data (e.g., at the 20th, 40th, 60th, and 80th percentiles). When the latter is the method chosen, rather than choosing the values for the knots, the analyst chooses the *df* for the model. This can be specified by choosing `df=` rather than `knots=` in the `bs()` function. We set this to $D + k$, where $D$ is the degree of the polynomial fitted, and $k$ is the desired number of interior knots. For example, if we wanted a cubic polynomial spline with two interior knots, we would set `df=5`.

```{r}
# Fit cubic spline using B-spline basis with two uniformly distributed interior knots
bs.2 = lm(water_use ~ 1 + bs(year, df = 5), data = tokyo)
```

The plot above shows the fitted spline models for the model in which we defined the interiror knots at 1980 and 1992 (black line) and for the spline model in which we let the software choose the two interior knots (at the 33rd and 66th percentiles) based on the data (red line).

```{r echo=FALSE}
# Set up plot data
plot_data2 = data.frame(
  year = seq(from = 1973, to = 1999, by = 0.1)
) %>%
  mutate(
    yhat = predict(bs.2, newdata = .)
  )


# Plot fitted lines for both spline models
ggplot(data = plot_data, aes(x = year, y = yhat)) +
  geom_line() +
  geom_point(data = tokyo, aes(x = year, y = water_use), alpha = 0.5) +
  theme_bw() +
  scale_x_continuous(name = "Year", breaks = seq(from = 1970, to = 2005, by = 5)) +
  scale_y_continuous(
    name = "Residential water use (in 1000 cubic feet)", 
    breaks = seq(from = 600000, to = 740000, by = 20000)
  ) +
  geom_line(data = plot_data2, color = "red")
```


The different knot placement resulted in a different fitted model. What happens if we choose a different number of knots? The plot below shows the fitted models based on differing numbers of knots.

```{r echo=FALSE, fig.width=6, fig.height=4, out.width='80%'}

# Fit cubic spline using B-spline basis with two uniformly distributed interior knots
bs.2 = lm(water_use ~ 1 + bs(year, df = 5), data = tokyo)
bs.3 = lm(water_use ~ 1 + bs(year, df = 6), data = tokyo)
bs.4 = lm(water_use ~ 1 + bs(year, df = 7), data = tokyo)
bs.5 = lm(water_use ~ 1 + bs(year, df = 8), data = tokyo)

# Set up plot data
plot_data = data.frame(
  year = seq(from = 1973, to = 1999, by = 0.1)
) %>%
  mutate(
    yhat = predict(bs.1, newdata = .),
    model = "2 knots (1980, 1992)"
  ) 

plot_data2 = data.frame(
  year = seq(from = 1973, to = 1999, by = 0.1)
) %>%
  mutate(
    yhat = predict(bs.2, newdata = .),
    model = "2 knots (df=5)"
  ) 

plot_data3 = data.frame(
  year = seq(from = 1973, to = 1999, by = 0.1)
) %>%
  mutate(
    yhat = predict(bs.3, newdata = .),
    model = "3 knots (df=6)"
  ) 

plot_data4 = data.frame(
  year = seq(from = 1973, to = 1999, by = 0.1)
) %>%
  mutate(
    yhat = predict(bs.4, newdata = .),
    model = "4 knots (df=7)"
  ) 

plot_data5 = data.frame(
  year = seq(from = 1973, to = 1999, by = 0.1)
) %>%
  mutate(
    yhat = predict(bs.5, newdata = .),
    model = "5 knots (df=8)"
  ) 

combined_data = rbind(plot_data, plot_data2, plot_data3, plot_data4, plot_data5)

# Plot fitted lines for both spline models
ggplot(data = combined_data, aes(x = year, y = yhat)) +
  geom_line(aes(color = model)) +
  geom_point(data = tokyo, aes(x = year, y = water_use), alpha = 0.5) +
  theme_bw() +
  scale_x_continuous(name = "Year", breaks = seq(from = 1970, to = 2005, by = 5)) +
  scale_y_continuous(
    name = "Residential water use (in 1000 cubic feet)", 
    breaks = seq(from = 600000, to = 740000, by = 20000)
  ) +
  scale_color_brewer(name = "Model", palette = "Set1")


```


As with the knot placement, models with different numbers of interior knots produce different fitted models. How do you choose the number of knots? One way is to try out models with different number of knots and see which fitted model produces the best-looking and interpretable curve. Another way to pick the number of knots is to treat this as a model selction problem. You could fit models with different numbers of knots and then use cross-validation or model-evidence methods to select the number of knots to use. 

```{r}
library(AICcmodavg)

aictab(
  cand.set = list(bs.2, bs.3, bs.4, bs.5), 
  modnames = c("2 knots (df=5)", "3 knots (df=6)", "4 knots (df=7)", "5 knots (df=8)")
  )
```


Here the model with the most empirical evidence (given the data and candidate set of models) has two interior knots. There is also some empirical evidence for the model having three interior knots. To further evaluate them, we will examine their residuals.


```{r echo=FALSE, fig.width=8, fig.height=4, out.width='60%'}
# Augment the model
out_bs_2 = data.frame(.fitted = fitted(bs.2), .std.resid = rstandard(bs.2))
out_bs_3 = data.frame(.fitted = fitted(bs.3), .std.resid = rstandard(bs.3))

# Evalate residuals
par(mfrow=c(1, 2))
sm.density(out_bs_2$.std.resid, model = "normal", xlab = "Standardized residuals from model with 2 knots (df=5)")
sm.density(out_bs_3$.std.resid, model = "normal", xlab = "Standardized residuals from model with 3 knots (df=6)")
par(mfrow=c(1, 1))

p1 = out_bs_2 %>%
  ggplot(aes(x = .fitted, y = .std.resid)) +
  geom_point()  +
  geom_smooth() +
  geom_hline(yintercept = 0) +
  theme_bw() +
  xlab("Fitted values") +
  ylab("Standardized residuals") +
  ggtitle("Model with 2 knots (df=5)")

p2 = out_bs_3 %>%
  ggplot(aes(x = .fitted, y = .std.resid)) +
  geom_point()  +
  geom_smooth() +
  geom_hline(yintercept = 0) +
  theme_bw() +
  xlab("Fitted values") +
  ylab("Standardized residuals") +
  ggtitle("Model with 3 knots (df=6)")

gridExtra::grid.arrange(p1, p2, nrow = 1)
```

Both models show reasonable fit to the normality assumption (at least to marginal normality). The assumption that the conditional mean residual is zero (for all fitted values) and homogeneity of variance also seems reasonable for both models. Based on this and Ocaam's razer, we will adopt the model with two interior knots. 

To determine the knot placement, you can access the model's attributes, specifically the `predvars` used in the model.

```{r}
attr(bs.2$terms, "predvars")
```

Note that in this model interior knots were placed at 1981.67 (the 33rd percentile) and at 1990.3 (the 66,7th percentile). There were also boundary knots placed at 1973 and 1999. The interior knots could also be defined using the `quantile()` function and then called in the `knots=` argument of the `bs()` function.

```{r}
# Get knot placement
my_knots = quantile(tokyo$year, probs = c(1/3, 2/3))
my_knots

# Fit model
bs.2.2 = lm(water_use ~ 1 + bs(year, knots = my_knots), data = tokyo)
```



Knot placement and choosing the number of knots is a difficult methodological problem and this gets worse with more than one predictor. With more than one predictor, you would have to select the knot placement and degrees of freedom for each predictor. In these cases we often take a very pragmatic approach and set the number of interior knots for all predictors to be a fixed value, say 3 or 4. Much of the methodolgocal research to date suggests that most of the time choosing three to four interior knots results in reasonable fit for most situtations.

### Graphical Uncertainty

Again, since the primary interpretational aid is the plot, it behooves us to include a confidence interval for the fitted spline model. And, given that the normality assumption seemed reasonable, we can produce confidence limits for our fitted model by adding/subtracting two SEs from the fitted value. We can do this using the same methodology we used to fit the envelope for piecewise models.

```{r}
# Set up data for plotting
plot_data = data.frame(
  year = seq(from = 1973, to = 1999, by = 0.1)
) 

# Compute fitted values and SEs
preds = predict(bs.2, newdata = plot_data, se.fit = TRUE)

# Add the fitted values, SEs, and limits to the plotting data
plot_data = plot_data %>%
  mutate(
    yhat = preds$fit,
    se = preds$se.fit,
    lower_limit = yhat - 2*se,
    upper_limit = yhat + 2*se
  )

# Plot
ggplot(data = plot_data, aes(x = year, y = yhat)) +
  geom_line(color = "red") +
  geom_line(aes(y = lower_limit), color = "red", linetype = "dashed") +
  geom_line(aes(y = upper_limit), color = "red", linetype = "dashed") +
  geom_point(data = tokyo, aes(x = year, y = water_use), alpha = 0.5) +
  theme_bw() +
  scale_x_continuous(name = "Year", breaks = seq(from = 1970, to = 2005, by = 5)) +
  scale_y_continuous(
    name = "Residential water use (in 1000 cubic feet)", 
    breaks = seq(from = 600000, to = 740000, by = 20000)
  )
```

Overall the uncertainty for the spline model is quite low. The exception is for extreme *x*-values, especially at the end-points. For those values the spline model indicates a severe amount of uncertainty. 


## Natural Splines

Natural splines are similar to B-splines, except they have the additional constraint that the the function is linear at the boundaries (in the region where $X$ is smaller than the smallest knot and larger than the largest knot). This additional constraint generally makes the model more stable at the boundaries (especially when extrapolating) giving a smaller confidence envelope at the endpoints of the predictor. 

To fit the natural spline we use the `ns()` function from the **splines** library. We can again specify the location of the knots using `knots=` or the number of knots via `df=` based on the formula $\mathit{df} = D + k - 2$ where $D$ is the degree polynomial and  $k$ is the number of internal knots to use. To fit a cubic spline model with two internal knots, we use `df=3`. (We subtract two because of the linear boundary constraint at both ends of the data).

```{r}
# Fit natural spline model with two knots
ns.2 = lm(water_use ~ 1 + ns(year, df = 3), data = tokyo)

# Obtain knot locations
attr(ns.2$terms, "predvars")
```


The knot locations are again at the 33.3rd and 66.7th percentiles of the `year` variable, namely 1981.7 and 1990.3. The plot of the fitted natural spline model is shown below:

```{r}
# Set up plotting data
plot_data_ns = data.frame(
  year = seq(from = 1973, to = 1999, by = 0.1)
) 

# Compute fitted values and SEs
preds_ns = predict(ns.2, newdata = plot_data_ns, se.fit = TRUE)

# Add the fitted values, SEs, and limits to the plotting data
plot_data_ns = plot_data_ns %>%
  mutate(
    yhat = preds_ns$fit,
    se = preds_ns$se.fit,
    lower_limit = yhat - 2*se,
    upper_limit = yhat + 2*se
  )

# Plot
ggplot(data = plot_data_ns, aes(x = year, y = yhat)) +
  geom_line(color = "blue") +
  geom_line(aes(y = lower_limit), color = "blue", linetype = "dashed") +
  geom_line(aes(y = upper_limit), color = "blue", linetype = "dashed") +
  geom_point(data = tokyo, aes(x = year, y = water_use), alpha = 0.5) +
  theme_bw() +
  scale_x_continuous(name = "Year", breaks = seq(from = 1970, to = 2005, by = 5)) +
  scale_y_continuous(
    name = "Residential water use (in 1000 cubic feet)", 
    breaks = seq(from = 600000, to = 740000, by = 20000)
  )
```


The benefit in stability is seen in the boundary regions. Below, we will extrapolate the model and SEs to 1970 and 2005.

```{r echo=FALSE}
# Set up data for plotting
plot_data_bs = data.frame(
  year = seq(from = 1970, to = 2005, by = 0.1)
) 

# Compute fitted values and SEs
preds_bs = predict(bs.2, newdata = plot_data_bs, se.fit = TRUE)

# Add the fitted values, SEs, and limits to the plotting data
plot_data_bs = plot_data_bs %>%
  mutate(
    yhat = preds_bs$fit,
    se = preds_bs$se.fit,
    lower_limit = yhat - 2*se,
    upper_limit = yhat + 2*se
  )


plot_data_ns = data.frame(
  year = seq(from = 1970, to = 2005, by = 0.1)
) 

# Compute fitted values and SEs
preds_ns = predict(ns.2, newdata = plot_data_ns, se.fit = TRUE)

# Add the fitted values, SEs, and limits to the plotting data
plot_data_ns = plot_data_ns %>%
  mutate(
    yhat = preds_ns$fit,
    se = preds_ns$se.fit,
    lower_limit = yhat - 2*se,
    upper_limit = yhat + 2*se
  )

# Plot
ggplot(data = plot_data_bs, aes(x = year, y = yhat)) +
  geom_line(color = "red") +
  geom_line(aes(y = lower_limit), color = "red", linetype = "dashed") +
  geom_line(aes(y = upper_limit), color = "red", linetype = "dashed") +
  geom_line(data = plot_data_ns, color = "blue") +
  geom_line(data = plot_data_ns, aes(y = lower_limit), color = "blue", linetype = "dashed") +
  geom_line(data = plot_data_ns, aes(y = upper_limit), color = "blue", linetype = "dashed") +
  geom_point(data = tokyo, aes(x = year, y = water_use), alpha = 0.5) +
  theme_bw() +
  scale_x_continuous(name = "Year", breaks = seq(from = 1970, to = 2005, by = 5)) +
  scale_y_continuous(
    name = "Residential water use (in 1000 cubic feet)", 
    breaks = seq(from = 400000, to = 900000, by = 50000)
  )



```

The plot shows the fitted lines for the natural cubic spline (blue) and the cubic B-spline (red). Past the boundary knots of 1973 and 1999, the B-spline model shows a great deal of uncertainty. The natural cubic spline shows smaller SEs (less uncertainty) for the same regions. You can also see the linearity constraint in the natural cubic spline model in these regions.

## References


