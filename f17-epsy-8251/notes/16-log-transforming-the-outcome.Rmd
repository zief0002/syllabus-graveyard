---
title: "Variance Stabilizing Transformation: Log-Transforming the Outcome"
date: "`r Sys.Date()`"
header-includes:
   - \usepackage{xcolor}
   - \usepackage[framemethod=tikz]{mdframed}
   - \usepackage{graphicx}
   - \usepackage{rotating}
   - \usepackage{booktabs}
   - \definecolor{umn}{RGB}{153, 0, 85}
   - \definecolor{umn2}{rgb}{0.1843137, 0.4509804, 0.5372549}
   - \definecolor{myorange}{HTML}{EA6153}
output: 
  pdf_document:
    highlight: tango
urlcolor: "umn2"
bibliography: epsy8251.bib
csl: apa-single-spaced.csl
always_allow_html: yes
---

```{r knitr_init, echo=FALSE, cache=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
opts_chunk$set(prompt=FALSE, comment=NA, message=FALSE, warning=FALSE, tidy=FALSE, fig.width=6, fig.height=6)
opts_knit$set(width=85)
options(scipen=5)
```


## Preparation

In this set of notes, you will learn about transforming the outcome variable as a method for dealing with heteroscadesticity and non-normality. Specifically, we will look at transforming the outcome variable using a logarithmic transformation. The data we will use in this set of notes, *movies.csv*, contains data for $n=1,806$ movies. We will use these data to explore two potential predictors of budget; namely age of a movie and the MPAA rating. The variables are:

- `title`: Movie's title
- `budget`: Movie's budget (in millions of U.S. dollars)
- `age`: Age of the movie; Computed by subtracting the movie's release date from 2017
- `mpaa`: MPAA rating (PG, PG-13, R)

These data are a subset of data from the `movies` data object included in the **ggplot2movies** package. The original data contains information on 24 variables collected from 28,819 movies.


```{r message=FALSE}
# Load libraries
library(broom)
library(dplyr)
library(ggplot2)
library(readr)
library(sm)

# Read in data
movies = read_csv(file = "~/Dropbox/epsy-8251/data/movies.csv")
head(movies)
```

\newpage

# Relationship between Budget and MPAA Rating

The primary research question we will address in whether there are mean differences in movie budget between movies with different MPAA Ratings. we will also examine the relationship between budget and MPAA rating.

```{r message=FALSE, warning=FALSE, out.width='3in'}
# Plot the observed data
ggplot(data = movies, aes(x = mpaa, y = budget)) +
  geom_boxplot() +
	theme_bw() +
	xlab("MPAA rating") +
	ylab("Movie Budget (in millions of dollars)")

# Compute summary statistics
movies %>%
  group_by(mpaa) %>%
  summarize(M = mean(budget), SD = sd(budget))
```

The side-by-side boxplots and summary statistics show there are differences in the mean budgets for the three MPAA ratings. All three conditional distributions of budget are positively skewed, and each seems to have movies with exceedingly large budgets (potential outliers). Lastly, looking at the box widths AND the overall range of each distribution, the plot suggests potential heterogeneity of variance.

To examine these issues further, we will fit a linear model including MPAA rating as a predictor of budget and scrutinize the residuals.

```{r out.width='3in', warning=FALSE}
# Fit linear model
lm.1 = lm(budget ~ 1 + mpaa, data = movies)

# Obtain residuals
out = augment(lm.1)

# Plot std. residuals vs. fitted values
ggplot(data = out, aes(x = .fitted, y = .std.resid)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  theme_bw()
```

```{r fig.width=9, fig.height=3, out.width='5in'}
# Obtain each mpaa ratings residuals
PG = out %>% filter(mpaa == "PG")
PG13 = out %>% filter(mpaa == "PG-13")
R = out %>% filter(mpaa == "R")

# Density plots
par(mfrow = c(1, 3))
sm.density(PG$.std.resid, model = "Normal", main = "PG")
sm.density(PG13$.std.resid, model = "Normal", main = "PG")
sm.density(R$.std.resid, model = "Normal", main = "PG")
par(mfrow = c(1, 1))
```

The residual plots confirm that non-normality is a problem. They also show some evidence of heteroskedasticity. 

# Transform the Outcome Using the Natural Logarithm (Base-e)

To alleviate problems of non-normality when the conditional distributions are right-skewed (or have high-end outliers) OR to alleviate heteroskadisticy, we can mathematically transform the outcome using a logarithm. Any base can be used for the logarithm, but we will transform the outcome using the natural logarithm because of the interpretive value. 

First, we will create the log-transformed variable as a new column in the data, and then we will use the log-transformed budget (rather than raw budget) in any analyses. To log-transform we use the `log()` function. This function has an argument, `base=`, to change the base used in the logarithm. By default this is set to base-$e$ (the natural logarithm).

```{r}
movies = movies %>% mutate(Lbudget = log(budget))
head(movies)
```

## Some Quick Math

Recall that the logarithm is the inverse function of an exponent. As an example, consider the budget and log-transformed budget for *'Til There Was You*. 

$$
\begin{split}
\ln(\textrm{Budget}) &= 3.135 \\
\ln(23.0) &= 3.135 \\
\end{split}
$$

Or,

$$
e^{3.135} = 23.0
$$

The logarithm answers the mathematical question:

\begin{center}
$e$ to what power is equal to 23.0?
\end{center}


## Re-analyze using the Log-Transformed Budget

Now we will re-examine the scatterplot using the log-transformed outcome to see how this transformation affects the relationship.


```{r message=FALSE, warning=FALSE, out.width='3in'}
# Plot the conditional distributions
ggplot(data = movies, aes(x = mpaa, y = Lbudget)) +
  geom_point() +
  theme_bw() +
	xlab("Movie age") +
	ylab("ln(Movie Budget)")

# Compute summary statistics
movies %>%
  group_by(mpaa) %>%
  summarize(M = mean(Lbudget), SD = sd(Lbudget))
```

Log-transforming the outcome has drastically affected the scale for the outcome. Now the conditional distributions show movies that are potential outliers at the low-end of log-budget. The summary statistics also show that the conditional distributions have much more equal variances. We can probably also see this in the residuals.

```{r out.width='3in', warning=FALSE}
# Fit linear model
lm.2 = lm(Lbudget ~ 1 + mpaa, data = movies)

# Obtain residuals
out2 = augment(lm.2)

# Plot std. residuals vs. fitted values
ggplot(data = out2, aes(x = .fitted, y = .std.resid)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  theme_bw()
```

```{r fig.width=9, fig.height=3, out.width='5in'}
# Obtain each mpaa ratings residuals
PG2 = out2 %>% filter(mpaa == "PG")
PG132 = out2 %>% filter(mpaa == "PG-13")
R2 = out2 %>% filter(mpaa == "R")

# Density plots
par(mfrow = c(1, 3))
sm.density(PG2$.std.resid, model = "Normal", main = "PG")
sm.density(PG132$.std.resid, model = "Normal", main = "PG")
sm.density(R2$.std.resid, model = "Normal", main = "PG")
par(mfrow = c(1, 1))
```

The residuals show better fit to the normality assumption (although not perfect) and similarly to the homogeneity of variance assumption. 

## Interpreting the Regression Output

Let's examine the output from the model that regressed log-transformed budget on MPAA rating

```{r}
summary(lm.2)
```


The model-level summary information suggests that differences in MPAA rating explains 8.9\% of the variation in budget. (Remember, explaining variation in log-budget is the same as explaining variation in budget). Although this is a small amount of variation, it is statistically significant, $F(2,1803)=88.28$, $p<0.001$. 


From the coefficient-level output we see that R chose PG (the first level in the `mpaa` variable alpabetically) to be the reference group. The fitted equation is

$$
\ln\left(\hat{\mathrm{Budget}_i}\right) = 2.88 + 0.26(\mathrm{PG\mbox{-}13}_i) - 0.87(\mathrm{R}_i)
$$

With log-transformations, there are two possible interpretations we can offer. The first is to interpret the coefficients using the log-transformed values. These we interpret in the exact same way we do any other regression coefficients (except we use log-outcome instead of outcome):

- The intercept, $\hat{\beta_0} = 2.88$, is the average predicted log-budget for PG rated movies.
- The slope associated with PG-13, $\hat{\beta_1} = 0.26$, indicates that PG-13 rated movies have a log-budget that is 0.26 higher than PG rated movies, on average.
- The slope associated with R, $\hat{\beta_2} = -0.87$, indicates that R rated movies have a log-budget that is 0.87 lower than PG rated movies, on average.

### Back-Transforming: A More Useful Interpretation

A second, probably more useful, interpretation is to back-transform log-budget to budget. To think about how to do this, we first consider a more general expression of the fitted linear model:

$$
\ln\left(\hat{Y}\right) = \hat\beta_0 + \hat\beta_1(X_{1}) + \hat\beta_2(X_{2})
$$

The left-hand side of the equation is in the log-transformed metric, which drives our interpreatations. If we want to instead, interpret using the raw metric of $Y$, we need to back-transform from $\ln(Y)$ to $Y$. To back-transform, we use the inverse function, which is to exponentiate using the base of the logarithm, in our case, base-$e$. 

$$
e^{\ln(Y)} = Y
$$

If we exponentiate the left-hand side of the equation, to maintain the equality, we also need to exponentiate the right-hand side of the equation.

$$
e^{\ln(Y)} = e^{\hat\beta_0 + \hat\beta_1(X_{1}) + \hat\beta_2(X_{2})}
$$

Then we use rules of exponents to simplify this.

$$
Y = e^{\hat\beta_0} \times e^{\hat\beta_1(X_{1})} \times e^{\hat\beta_2(X_{2})}
$$

For our example, when we exponentiate both sides of the fitted equation:

$$
\hat{\mathrm{Budget}_i} = e^{2.88} \times e^{0.26(\mathrm{PG\mbox{-}13}_i)} \times e^{-0.87(\mathrm{R}_i)}
$$

### Substituting in the Dummy Variables to Interpret Effects

To interpret the effects (which are now interpreted using budget---not log-budget) we can substitute in the different dummy variable patterns and solve.

$$
\begin{split}
\textbf{PG Movie:}~~ \hat{\mathrm{Budget}_i} &= e^{2.88} \times e^{0.26(0)} \times e^{-0.87(0)}\\
&= 17.81 \times 1 \times 1 \\
&= 17.81
\end{split}
$$

The model estimated budget for a PG rated movie is 17.81 million dollars.


$$
\begin{split}
\textbf{PG-13 Movie:}~~ \hat{\mathrm{Budget}_i} &= e^{2.88} \times e^{0.26(1)} \times e^{-0.87(0)}\\
&= 17.81 \times 1.30 \times 1 \\
&= 23.15
\end{split}
$$

The model estimated budget for a PG-13 rated movie is 23.15 million dollars. This is 1.30 TIMES the estimated budget for a PG rated movie.

$$
\begin{split}
\textbf{R Movie:}~~ \hat{\mathrm{Budget}_i} &= e^{2.88} \times e^{0.26(0)} \times e^{-0.87(1)}\\
&= 17.81 \times 1 \times 0.42 \\
&= 7.48
\end{split}
$$

The model estimated budget for an R rated movie is 7.48 million dollars. This is 0.42 TIMES the estimated budget for a PG rated movie.

Simply put, when we back-transform from interpretations of log-$Y$ to $Y$ the interpretations are multiplicatively related to the intercept rather than additive. We can obtain these multiplicative values (and the back-transformed intercept) by using the `exp()` function to exponentiate the coefficients from the fitted model, which we obtain using the `coef()` function.

```{r}
exp(coef(lm.2))
```

# Relationship between Budget and Age

Suppose now that we wanted to include the age of a movie in the model as well as MPAA rating. Since we log-transformed the outcome, we need to see how age is related to log-budget. (We will also, for pedagogical purposes, examine the relationship with age and raw-budget as well.)


```{r message=FALSE, warning=FALSE, fig.width=8, fig.height=4, out.width='5in'}
# Relationship with raw-budget
p1 = ggplot(data = movies, aes(x = age, y = budget)) +
  geom_point() +
  geom_smooth(se = FALSE) +
	theme_bw() +
	xlab("Movie age") +
	ylab("Movie Budget (in millions of dollars)") +
  ggtitle("Raw-Budget")

# Relationship with log-budget
p2 = ggplot(data = movies, aes(x = age, y = Lbudget)) +
  geom_point() +
  geom_smooth(se = FALSE) +
	theme_bw() +
	xlab("Movie age") +
	ylab("Ln(Movie Budget)") +
  ggtitle("Log-Budget")

gridExtra::grid.arrange(p1, p2, nrow = 1)
```

Examining the relationship between age and raw-budget, we see a non-linear, negative effect of age on budget, in the sample. In other words, older movies tend to have a smaller budget, on average, but this decrease is not constant. This pattern of non-linear decline is referred to as *exponential decay*. The scatterplot also foreshadows issues with homogeneity of variance and also suggest the relationship may be nonlnear. 

The relationship between age and log-budget is much more fortuitous for fitting a linear model. The exponential decay pattern we observed with raw-budget seems much more linear (most of the non-linearity observed in the loess smoother can be attributed to the sparsity of data on the right-hand side of the plot rather than to a non-linear relationship in the data). We also see that the log-transformed data conform much more to the assumption of homogeneity of variance.

## Fitting the Linear Model and Interpreting the Coefficients

Although we are mostly interested in age as a control in our MPAA model, we will fit the simple regression using age to predict log-budget to get a feel for how to interpret coefficients when we have a continuous predictor.


```{r out.width='3in'}
lm.3 = lm(Lbudget ~ 1 + age, data = movies)
summary(lm.3)
```

The model-level summary information suggests that differences in age of a movie explains 2.1\% of the variation in budget. (Remember, explaining variation in log-budget is the same as explaining variation in budget). Although this is a small amount of variation, it is statistically significant, $F(1,1804)=39.27$, $p<0.001$. 

To interpret the coefficients, we will again exponentiate the fitted coefficients so we can interpret them using the raw-metric of budget.

```{r}
exp(coef(lm.3))
```

- The model estimated budget for a movie that was made in 2017 (age = 0) is 25.38 million dollars.
- Each one-year difference in age is associated with a 0.95 TIMES difference in budget, on average.

Rather than using the language of **TIMES difference** most social scientists would either use the language **fold difference**. In this case the slope coefficient would be interpreted as,

- Each one-year difference in age is associated with a 0.95-fold difference in budget, on average.

One could also use PERCENT difference.

- Each one-year difference in age is associated with a 5\% budget decrease, on average.

This can be inferred directly from the slope cofficient in the `summary()` output; without having to exponentiate:

```
Coefficients:
             Estimate Std. Error t value Pr(>|t|)
(Intercept)  3.234047   0.132228  24.458  < 2e-16 ***
age         -0.044084   0.007035  -6.267  4.6e-10 ***
---
```

In general, multiplying the fitted slope coefficient by 100 will give a rough estimation of the percentage change. (Note: It is more accurate to use the formula $e^{\hat\beta_1} - 1$, which in our case gives $-.0392$ (a 3.92\% decrease), but when you do not have a computer handy to compute this, the shortcut will suffice.) This shortcut only works when we have transformed the outcome using the natural logarithm; any other base would not give the percent change directly in the output.

If you use the language of percent decrease/increase, be very careful. Percent change and percentage change are sometimes interpretted differently! It is generally more clear to use the *X-fold difference* language.

# Multiple Regression

Now we can fit a model that includes our focal predictor of MPAA rating, and our control predictor of age.

```{r}
lm.4 = lm(Lbudget ~ 1 + age + mpaa, data = movies)
```

To determine if there is an effect of MPAA rating, after accounting for differnces in age, we can use the nested $F$-test to compare the full model (`lm.4`) with a model that does not include MPAA rating, but does include age (`lm.3`).

```{r}
anova(lm.3, lm.4)
```

The test suggests that there is a statistically significant effect of MPAA rating evan after accounting for differences in age; $F(2, 1802)=89.21$, $p<.001$. To interpret these differences, we can examine the model output:

```{r}
summary(lm.4)
```

The model-level summary information suggests that differences in age and MPAA rating of a movie explains 11.0\% of the variation in budget. (Remember, explaining variation in log-budget is the same as explaining variation in budget); $F(3,1802)=73.84$, $p<0.001$. 

To interpret the coefficients, we will again exponentiate the fitted coefficients so we can interpret them using the raw-metric of budget.

```{r}
exp(coef(lm.4))
```

- The model estimated budget for a PG movie (reference group) that was made in 2017 (age = 0) is 39.95 million dollars.
- Each one-year difference in age is associated with a 4.3\% decrease in budget, on average, controlling for differences in MPAA rating.
- PG-13 rated movies have a budget that is 1.23 times that for PG movies, on average, controlling for differences in age. This budget difference is not statistically significant; unadjusted $p=0.123$.
- R rated movies have a budget that is 0.41 times that for PG movies, on average, controlling for differences in age. This budget difference is statistically significant; unadjusted $p<.001$.


To examine whether the age controlled budgets for PG-13 and R rated movies differ, we need to fit a model that uses one of these categories as the reference group.

```{r}
# Create dummy variables
movies = movies %>%
  mutate(
    PG = if_else(mpaa == "PG", 1, 0),
    R  = if_else(mpaa == "R",  1, 0)
  )

# Fit model (PG-13 is reference group)
lm.5 = lm(Lbudget ~ 1 + age + PG + R, data = movies)
summary(lm.5)

# Exponentiate the coefficients
exp(coef(lm.5))
```

- R rated movies have a budget that is 0.33 times that for PG-13 movies, on average, controlling for differences in age. This budget difference is statistically significant; unadjusted $p<.001$.

## Adjusting the p-Values for the Multiple MPAA Rating Comparisons

By examining the size of the $p$-values, it is pretty clear that after adjusting them,

- The PG vs. PG-13 difference will remain non-significant.
- The PG vs R difference will remain significant.
- The PG-13 vs R difference will remain significant.

However, for completeness, we will obtain the Benjamini-Hochberg adjusted $p$-values.

```{r}
# Vector of unadjusted p-values
p.values = c(0.123, 0.000000000000679, 0.0000000000000002)

# Adjust the p-values
p.adjust(p.values, method = "BH")
```


# Interaction Effect between MPAA Rating and Age

To study whether there is an interaction effect between MPAA rating and age, we will fit the interaction model and compare it to the main-effects model using the nested $F$-test.

```{r}
lm.4 = lm(Lbudget ~ 1 + age + mpaa, data = movies)
lm.6 = lm(Lbudget ~ 1 + age + mpaa + age:mpaa, data = movies)

anova(lm.4, lm.6)
```

The test suggests that we should adopt the main-effects model. The interaction-effect was not statistically significant; $F(2,1800)=1.41$, $p=.244$.

# Plotting the Fitted Main-Effects Model

Since we adopted the main-effects model, we can also produce a plot of the back-transformed fitted values (raw-budget) to aid interpretation of the effects. To create this plot, we use a range of age values and the different MPAA ratings to predict the log-budgets. Then we back-transform the log-budget to budget and plot age vs. budget for each of the MPAA ratings. Prior to doing this, we will refit the main-effects model using the original `mpaa` variable instead of the two dummy variables. This will make creating this plot easier.

```{r fig.width=8, fig.height=6, out.width='4in'}
# Set up data
plotData = expand.grid(
  age = 12:79,
  mpaa = c("PG", "PG-13", "R")
)

# Predict log-budget
plotData$Lbudget = predict(lm.4, newdata = plotData)

# Back-transform log-budget to budget
plotData$budget = exp(plotData$Lbudget)
head(plotData)

# Plot
ggplot(data = plotData, aes(x = age, y = budget, color = mpaa)) +
  geom_line() +
  theme_bw() +
  xlab("Movie age") +
  ylab("Budget (in millions of U.S. dollars)") +
  scale_color_brewer(name = "MPAA rating", palette = "Set1")
```

The plot helps us see (1) the exponential (decaying) relationship between movie age and budget for PG, PG-13, and R rated movies. It also helps us see the budget differences between PG, PG-13, and R rated movies are smaller for older movies. Even though we fitted a main-effects model, the fitted lines after we back-transform are not parallel.How non-parallel the lines are depends on the size of the coefficients associated with the MPAA effects (in this example). This is why, especially with transformed data, it is essential to plot the model to make sure you are understanding the interpretations from your coefficients.


